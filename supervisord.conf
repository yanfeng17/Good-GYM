[supervisord]
nodaemon=true
logfile=/dev/stdout
logfile_maxbytes=0

[program:pulseaudio]
command=pulseaudio --system --disallow-exit --disallow-module-loading=0 --high-priority
autorestart=true
priority=50

[program:X11]
command=/usr/bin/Xvfb :0 -screen 0 1920x1080x24
autorestart=true
priority=100

[program:x11vnc]
command=bash -c "while [ ! -S /tmp/.X11-unix/X0 ]; do echo 'x11vnc: Waiting for X11...'; sleep 1; done; sleep 2; exec /usr/bin/x11vnc -display :0 -forever -noxdamage -repeat -nopw -rfbport 5900 -shared"
autorestart=true
priority=200
environment=DISPLAY=":0"

[program:novnc]
command=bash -c "sleep 5; exec /usr/share/novnc/utils/novnc_proxy --vnc localhost:5900 --listen 6081"
autorestart=true
priority=300

[program:windowmanager]
command=/usr/bin/fluxbox
autorestart=true
environment=DISPLAY=":0"
priority=400

[program:audio_ws]
command=python3 /app/audio_ws_server.py
autorestart=true
priority=450
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

[program:app]
command=bash -c "mkdir -p /tmp/runtime-root && while [ ! -S /tmp/.X11-unix/X0 ]; do echo 'Waiting for X11...'; sleep 1; done; sleep 3; echo 'Checking data files...'; if [ ! -f /app/data/exercises.json ]; then echo 'Copying default data files...'; cp -rn /app/data_default/* /app/data/ 2>/dev/null || true; ls -la /app/data/; fi; python3 /app/run.py"
autorestart=true
environment=DISPLAY=":0",QT_X11_NO_MITSHM="1",QT_QPA_PLATFORM="xcb",QT_PLUGIN_PATH="/usr/local/lib/python3.9/site-packages/PyQt5/Qt5/plugins",QT_QPA_PLATFORM_PLUGIN_PATH="/usr/local/lib/python3.9/site-packages/PyQt5/Qt5/plugins/platforms",OPENCV_QT_PLUGIN_PATH="/usr/local/lib/python3.9/site-packages/PyQt5/Qt5/plugins",LIBGL_ALWAYS_SOFTWARE="1",MESA_GL_VERSION_OVERRIDE="3.3",XDG_RUNTIME_DIR="/tmp/runtime-root",PULSE_SERVER="unix:/run/pulse/native"
priority=500
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
